<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Speechily Audio Recorder</title>
</head>
<body>
    <h1>Speechily Audio Recorder</h1>
    <p>Record speech for analysis (stops after 1 minute)</p>
    <p>hit record, the recording sign will go away when you hit stop</p>

    <button id="recordBtn">Record</button>
    <button id="stopBtn" disabled>Stop</button>
    <div id="status">Recording...</div>
    <button id="getResults">Get Results</button>
    <div id="result">
        <h3>Transcript</h3>
        <p id="transcriptText"></p>
    
        <h3>Summary</h3>
        <p id="summaryText"></p>
    </div>

    <!-- recording from get user media example?  use getusermedia-->
    <script>

        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const resBtn = document.getElementById('getResults');
        const result = document.getElementById('result');

        // Variables
        let recorder;
        let chunks = [];
        let timer;

        recordBtn.onclick = function() {
    chunks = [];
    navigator.mediaDevices.getUserMedia({audio: true})
        .then(stream => {
            recorder = new MediaRecorder(stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = saveRecording;

            recorder.start();
            status.style.display = 'block';  // <- FIXED
            recordBtn.disabled = true;
            stopBtn.disabled = false;

            timer = setTimeout(() => stopBtn.click(), 60000);
        });
};

stopBtn.onclick = function() {
    if (recorder && recorder.state === 'recording') {
        clearTimeout(timer);
        recorder.stop();
        recorder.stream.getTracks().forEach(track => track.stop());
        status.style.display = 'none';  // <- FIXED
        recordBtn.disabled = false;
        stopBtn.disabled = true;
    }
};


        // auto save recording after done
        // looks like it needs to be web, not mp3
        function saveRecording() {
    const blob = new Blob(chunks, {type: 'audio/webm'});
    const formData = new FormData();
    formData.append('audio', blob, 'recording.webm');

    fetch('/upload', {
        method: 'POST',
        body: formData
    }).then(() => {
        // Optionally trigger processing immediately after upload
        setTimeout(() => {
            fetch("/result")
                .then((response) => response.json())
                .then((data) => {
                    document.getElementById("transcriptText").textContent = data.Transcript;
                    document.getElementById("summaryText").textContent = data.Summary;
                })
                .catch((error) => {
                    console.error("Error fetching result:", error);
                });
        }, 1500); // short delay so backend has time to process
    });
}


        resBtn.onclick = function () {
            fetch("/result")
                .then((response) => response.json())
                .then((data) => {
                document.getElementById("transcriptText").textContent = data.Transcript;
                document.getElementById("summaryText").textContent = data.Summary;
                })
                .catch((error) => {
                console.error("Error fetching result:", error);
                });
        };
    </script>
</body>
</html>